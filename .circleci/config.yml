version: 2
jobs:
  build:
    docker:
      - image: python:2.7
    steps:
      - checkout
      - run: 
          name: PIP Install
          command: pip install -r requirements.txt

      - run: 
          name: Unit Tests
          command: ./tests/bin/tests.sh

      - setup_remote_docker:
          docker_layer_caching: true

      # Build and push docker image
      - run:
          name: Install Docker client
          command: |
            set -x
            VER="17.03.0-ce"
            wget -O - https://download.docker.com/linux/static/stable/x86_64/docker-$VER.tgz | tar xz -C /tmp
            mv /tmp/docker/* /usr/bin
      
      - run: 
          name: Build Docker Image 
          command: |
            docker build -t bids-client .

      - deploy: 
          name: Deploy Docker Image
          command: |
            docker login -u $DOCKER_USER -p $DOCKER_PASS
            if [ "$CIRCLE_TAG" ]; then
              docker tag bids-client flywheel/bids-client:${CIRCLE_TAG}
              docker push flywheel/bids-client:${CIRCLE_TAG}
            fi
            if [ "$CIRCLE_BRANCH" == "master"]; then
              docker tag bids-client flywheel/bids-client:latest
              docker push flywheel/bids-client:latest
            fi
        


